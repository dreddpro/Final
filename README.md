# Проект № 4.

## Данные

Имеются 4 таблицы с данными

### 1. Таблица клиентов 10 000 записей

|Поле| Описание
|-------- | ----------|
| ClientId| Id клиента|
| ClientName | Наименование клиента |
| Type | Тип клиента (ФЛ. ЮЛ) |
| Form | Организационно-правовая форма|
| RegisterDate | Дата регистрации клиента
 

### 2. Таблица счетов – 20 000 записей     

|Поле| Описание
|-------- | ----------|
| AccountId| Id счета (pk) |
| AccountNum | Номер счета |
| ClientId | Id клиента владельца счета (fk) |
| DateOpen | Дата открытия счета


### 3. Операции по счетам – 100 000 записей

  |Поле| Описание
|-------- | ----------|
| AccountDB| Счет дебета проводки (fk)|
| AccountCR | Счет кредита проводки (fk) |
| DateOp | Дата операции|
| Amount | Сумма операции|
| Currency | Валюта операции
| Comment | Назначение платежа


### 4. Курсы валют по отношению к рублю

|Поле| Описание
|-------- | ----------|
| Currency | Валюта |
| Rate | Курс |
| RateDate | Дата курса |

 
## Задача

### Необходимо сформировать три витрины на следующие даты 2020-11-01, 2020-11-02, 2020-11-03, 2020-11-04.

### 1. Витрина _corporate_payments_. Строится по каждому уникальному счету (AccountDB  и AccountCR) из таблицы Operation. Ключ партиции CutoffDt

|Поле| Описание
|-------- | ----------|
| AccountId| Id счета|
| ClientId| Id клиента|
| PaymentAmt | Сумма операций по счету, где счет клиента указан в дебете проводки |
| EnrollementAmt | Сумма операций по счету, где счет клиента указан в кредите проводки |
| TaxAmt | Сумму операций, где счет клиента указан в дебете, и счет кредита 40702 |
| ClearAmt | Сумма операций, где счет клиента указан в кредите, и счет дебета 40802|
| CarsAmt | Сумма операций, где счет клиента указан в дебете проводки и назначение платежа не содержит слов по маскам Списка 1
| FoodAmt | Сумма операций, где счет клиента указан в кредите проводки и назначение платежа содержит слова по Маскам Списка 2
| FLAmt | Сумма операций с физ. лицами. Счет клиента указан в дебете проводки, а клиент в кредите проводки – ФЛ.
| CuttoffDt | Дата операции
 

### 2. Витрина _corporate_account_. Строится по каждому уникальному счету из таблицы Operation на заданную дату расчета. Ключ партиции CutoffDt

|Поле| Описание
|-------- | ----------|
| AccountId| Id счета|
| AccountNum| Номер счета|
| DateOpen | Дата открытия счета |
| ClientId | Id клиента |
| ClientName | Наименование клиента |
| TotalAmt | Общая сумма оборотов по счету. Считается как сумма PaymentAmt и EnrollementAmt|
| CuttoffDt | Дата операции
        

### 3. Витрина _corporate_info_. Строится по каждому уникальному клиенту из таблицы Operation. Ключ партиции CutoffDt

|Поле| Описание
|-------- | ----------|
| ClientId | Id клиента |
| ClientName | Наименование клиента |
| CuttoffDt | Дата операции
| Type | Тип клиента (ФЛ. ЮЛ) |
| Form | Организационно-правовая форма|
| RegisterDate | Дата регистрации клиента
| TotalAmt | Сумма операций по всем счетам клиент. Считается как сумма corporate_account.total_amt по всем счетам.|
| CutoffDt | Дата операции|
 





## Описание

Проект предназначен для определения суммы выполняемых операций по счетам клиентов.
В качестве исходных данных используются выгрузки .csv. Наиболее оптимальным вариантом обработки данных был выбран инструмент Apache Spark и Scala. Главными преимуществами является быстрая обработка данных и простота преобразований.


## ER-диаграмма
Данные с разным таблиц объединяем с помощью джойнов. За основную таблицу берется таблица с операциями (Operation.csv)

![диаграмма](Schema/Schema.png)

### Установка
Для настройки проекта необходимо было установить Anaconda3 и дополнительно настроить в нем модуль для scala - spylon-kernel.

### Ход выполнения

**1) На первом этапе определили схему данных в соотвествии с заданием.**

**2) Выгрузили данные из .csv файлов в датафреймы. Для столбца с операциями заменили запятые на точки**

**3) Объеденили таблицу со счетами с таблицей с клиентами**

**4) Подтянули таблицу с курсами валют, и примели все валюты к рублевому эквиваленту**  

**5) Далее произвели агрегирование по суммам**  

**6) По полученным данным построены витрины, сохранены в формате parquet для оптимизации хранения**


## Результаты
В результате получены данные по трем витринам за период четырех дней. Данные результаты сохранены в папку Vitrina.

corporate_payments
![corporate_payments](Screenshot/corporate_payments.png)

corporate_account
![corporate_account](Screenshot/corporate_account.png)

corporate_info
![corporate_info](Screenshot/corporate_info.png)



